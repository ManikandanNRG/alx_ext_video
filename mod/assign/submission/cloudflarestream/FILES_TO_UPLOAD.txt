CLOUDFLARE STREAM PLUGIN - FILES TO UPLOAD
==========================================

Upload these 7 files to your server:

1. mod/assign/submission/cloudflarestream/view_video.php
   → NEW FILE - View video in new tab

2. mod/assign/submission/cloudflarestream/amd/src/grading_injector.js
   → NEW FILE - JavaScript module for grading interface

3. mod/assign/submission/cloudflarestream/amd/build/grading_injector.min.js
   → NEW FILE - Minified version for production

4. mod/assign/submission/cloudflarestream/classes/task/cleanup_videos.php
   → MODIFIED - Added sync to detect manually deleted videos

5. mod/assign/submission/cloudflarestream/styles.css
   → MODIFIED - Added two-column layout styles

6. mod/assign/submission/cloudflarestream/lib.php
   → MODIFIED - Added clickable link + JavaScript loading

7. mod/assign/submission/cloudflarestream/lang/en/assignsubmission_cloudflarestream.php
   → MODIFIED - Added watchvideo language string


AFTER UPLOADING:
================

1. Clear Moodle cache:
   - Go to: Site administration → Development → Purge all caches
   - Or run: php admin/cli/purge_caches.php

2. Test the grading interface:
   - Go to an assignment with video submissions
   - Click "View all submissions"
   - Click "Grade" on a submission
   - You should see video on left (65%), grading on right (35%)


WHAT YOU'LL SEE:
================

1. SUBMISSION TABLE:
   Before: "Ready (9.7 MB)" - NOT clickable
   After:  "Ready (9.7 MB)" - CLICKABLE link (opens video in new tab)

2. GRADING PAGE:
   Before: Video and grading controls stacked vertically
   After:  Video on left side (65%), grading controls on right side (35%)

This matches the S3 Video plugin exactly!


FEATURES:
=========

✅ Clickable video link in submission table (opens in new tab)
✅ Two-column layout (65% video / 35% grading)
✅ Automatic injection on grading pages
✅ Responsive design (stacks on mobile)
✅ All grading features work normally
✅ Professional appearance
✅ No configuration needed
✅ Sync with Cloudflare (detects manually deleted videos)


ROLLBACK (if needed):
=====================

If you need to revert:
1. Delete view_video.php
2. Delete grading_injector.js and .min.js
3. Restore lib.php from backup
4. Restore styles.css from backup
5. Restore language file from backup
6. Clear Moodle cache



VIDEO DELETION BEHAVIOR:
========================

Scenario 1: Delete from Moodle plugin (videomanagement.php)
   → Deletes from Cloudflare ✅
   → Updates database (status='deleted') ✅
   → Works correctly ✅

Scenario 2: Delete from Cloudflare dashboard
   → Video deleted from Cloudflare ✅
   → Database NOT updated immediately ⚠️
   → Sync runs daily (cleanup task) to detect and update ✅
   → After sync: Database updated (status='deleted') ✅

Scenario 3: Scheduled cleanup task (runs daily)
   → Deletes old videos from Cloudflare ✅
   → Updates database records ✅
   → Syncs with Cloudflare to detect manual deletions ✅
   → Works correctly ✅

SYNC MECHANISM:
===============

The cleanup task now includes a sync step that:
1. Checks all videos marked as 'ready' in database
2. Verifies each video still exists in Cloudflare
3. If video not found in Cloudflare:
   - Updates database: status='deleted'
   - Sets deleted_timestamp
   - Adds note: "Video deleted from Cloudflare dashboard"

This runs daily, so manually deleted videos will be detected within 24 hours.
