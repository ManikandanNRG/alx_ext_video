# Requirements Document

## Introduction

This document specifies the requirements for integrating Cloudflare Stream with an IOMAD-based Moodle environment to enable seamless handling of large video uploads (up to 5 GB) submitted as fieldwork assignments. The integration will offload video storage and streaming to Cloudflare's infrastructure while maintaining full integration with Moodle's assignment workflow, user tracking, and access control.

## Glossary

- **Moodle System**: The IOMAD-based learning management system where students submit assignments and teachers grade them
- **Cloudflare Stream Service**: The external video hosting and streaming platform that stores and delivers video content
- **Video UID**: A unique identifier assigned by Cloudflare Stream to each uploaded video
- **Direct Upload URL**: A presigned URL generated by Cloudflare Stream API that allows browser-based uploads directly to Cloudflare
- **Signed Playback Token**: A JWT-based token that authorizes video playback for specific users with expiration
- **Assignment Submission Record**: The Moodle database entry that tracks a student's assignment submission
- **Custom Plugin**: The Moodle plugin component that handles Cloudflare Stream API integration
- **Embedded Player**: The Cloudflare Stream video player rendered within Moodle's interface

## Requirements

### Requirement 1

**User Story:** As a student, I want to upload large video files (up to 5 GB) for my fieldwork assignments, so that I can submit my work without encountering file size limitations or upload failures.

#### Acceptance Criteria

1. WHEN a student accesses the assignment submission page, THE Moodle System SHALL display a video upload interface
2. WHEN a student selects a video file up to 5 GB in size, THE Moodle System SHALL accept the file for upload
3. WHEN the upload is initiated, THE Custom Plugin SHALL request a Direct Upload URL from the Cloudflare Stream Service
4. WHEN the Direct Upload URL is received, THE Moodle System SHALL upload the video directly from the student's browser to the Cloudflare Stream Service
5. WHEN the upload completes successfully, THE Cloudflare Stream Service SHALL return a Video UID to the Moodle System

### Requirement 2

**User Story:** As a student, I want to see the progress of my video upload in real-time, so that I know the upload is working and can estimate when it will complete.

#### Acceptance Criteria

1. WHEN a video upload is in progress, THE Moodle System SHALL display a progress indicator showing the percentage completed
2. WHILE the upload is active, THE Moodle System SHALL update the progress indicator in real-time
3. IF the upload fails due to network interruption, THEN THE Moodle System SHALL display an error message with retry options
4. WHEN the upload completes successfully, THE Moodle System SHALL display a confirmation message to the student

### Requirement 3

**User Story:** As a teacher, I want to view student video submissions directly within the Moodle grading interface, so that I can review and grade assignments without leaving the platform.

#### Acceptance Criteria

1. WHEN a teacher opens a student's assignment submission for grading, THE Moodle System SHALL retrieve the Video UID associated with that submission
2. WHEN the Video UID is retrieved, THE Custom Plugin SHALL generate a Signed Playback Token for the teacher
3. WHEN the Signed Playback Token is generated, THE Moodle System SHALL render the Embedded Player with the student's video
4. WHILE viewing the video, THE Moodle System SHALL stream the content from the Cloudflare Stream Service without using Moodle server bandwidth

### Requirement 4

**User Story:** As a system administrator, I want video access to be restricted to authorized users only, so that student submissions remain private and secure.

#### Acceptance Criteria

1. WHEN a video playback request is made, THE Custom Plugin SHALL verify the user is authenticated in the Moodle System
2. WHEN generating a playback URL, THE Custom Plugin SHALL create a Signed Playback Token that includes the Video UID, user ID, and expiration timestamp
3. THE Custom Plugin SHALL set the Signed Playback Token expiration to 24 hours from generation time
4. IF an unauthorized user attempts to access a video, THEN THE Moodle System SHALL deny access and display an error message
5. WHEN a student views their own submission, THE Moodle System SHALL display only videos associated with their user ID

### Requirement 5

**User Story:** As a system administrator, I want to track which videos belong to which students and assignments, so that the system maintains data integrity and proper access control.

#### Acceptance Criteria

1. WHEN a video upload completes, THE Moodle System SHALL store the Video UID in the Assignment Submission Record
2. WHEN storing the Video UID, THE Moodle System SHALL associate it with the user ID, course ID, assignment ID, and submission timestamp
3. WHEN retrieving a video for playback, THE Custom Plugin SHALL verify the Video UID matches the requested submission context
4. THE Moodle System SHALL prevent cross-access by ensuring users can only view videos associated with their own submissions or submissions they are authorized to grade

### Requirement 6

**User Story:** As a system administrator, I want the system to bypass Moodle's server storage for video files, so that we avoid server load and storage overhead.

#### Acceptance Criteria

1. WHEN a video upload is initiated, THE Moodle System SHALL transmit the video data directly from the student's browser to the Cloudflare Stream Service
2. THE Moodle System SHALL NOT store video file data on the Moodle server at any point during the upload process
3. WHEN a video is played back, THE Moodle System SHALL stream the content directly from the Cloudflare Stream Service to the user's browser
4. THE Moodle System SHALL NOT proxy or cache video content through the Moodle server during playback

### Requirement 7

**User Story:** As a system administrator, I want to configure Cloudflare API credentials securely, so that the integration can authenticate with Cloudflare Stream Service without exposing sensitive information.

#### Acceptance Criteria

1. THE Custom Plugin SHALL provide a configuration interface for entering the Cloudflare API token
2. WHEN the API token is saved, THE Moodle System SHALL store it in encrypted form in the Moodle database
3. WHEN making API requests to Cloudflare Stream Service, THE Custom Plugin SHALL include the API token in the authorization header
4. THE Moodle System SHALL NOT expose the API token in client-side code or browser network requests

### Requirement 8

**User Story:** As a system administrator, I want to implement automatic cleanup of old videos, so that storage costs remain manageable over time.

#### Acceptance Criteria

1. THE Moodle System SHALL provide a configurable retention period for video submissions (default 90 days)
2. WHEN a video submission exceeds the retention period, THE Moodle System SHALL identify it for deletion
3. WHEN a scheduled cleanup task runs, THE Custom Plugin SHALL delete expired videos from the Cloudflare Stream Service via API
4. WHEN a video is deleted from Cloudflare Stream Service, THE Moodle System SHALL update the Assignment Submission Record to reflect the deletion status

### Requirement 9

**User Story:** As a system administrator, I want to monitor upload success rates and bandwidth usage, so that I can track system performance and costs.

#### Acceptance Criteria

1. WHEN a video upload completes, THE Moodle System SHALL log the upload status (success or failure) with timestamp
2. WHEN a video upload fails, THE Moodle System SHALL log the error details for troubleshooting
3. THE Custom Plugin SHALL provide an administrative dashboard displaying upload statistics and failure rates
4. THE Custom Plugin SHALL provide integration with Cloudflare Stream Service analytics for bandwidth tracking

### Requirement 10

**User Story:** As a teacher, I want to provide feedback on video submissions within the same interface where I view them, so that I can efficiently grade assignments.

#### Acceptance Criteria

1. WHEN a teacher views a video submission, THE Moodle System SHALL display the standard Moodle grading interface alongside the Embedded Player
2. WHEN a teacher enters a grade or feedback, THE Moodle System SHALL save it to the Assignment Submission Record
3. THE Moodle System SHALL maintain all existing Moodle assignment grading features (rubrics, comments, grade scales) when video submissions are used
